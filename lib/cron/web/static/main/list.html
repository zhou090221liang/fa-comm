<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Cron任务调度</title>
</head>

<link rel="stylesheet" href="../style/mui.min.css">
<link rel="stylesheet" href="../style/mui.showLoading.css">
<script type="text/javascript" src="../jscript/mui.min.js"></script>
<script type="text/javascript" src="../jscript/mui.showLoading.js"></script>
<script type="text/javascript" src="../jscript/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="../jscript/comm.js"></script>
<script type="text/javascript" src="../jscript/ajax.js"></script>
<script type="text/javascript">
    var si;
    $(function () {
        load();
        $('#auto_ref_time').on('change', function () {
            var t = parseInt($('#auto_ref_time').val());
            if (t) {
                if (si) {
                    clearInterval(si);
                }
                si = setInterval(load, t * 1000);
            } else {
                if (si) {
                    clearInterval(si);
                    si = null;
                }
            }
        });
    });

    function load() {
        mui.showLoading();
        $ajax({
            url: '/api/cron/list',
            success: function (data) {
                mui.hideLoading();
                if (data.error_code != 0) {
                    mui.alert(data.error_message);
                    return;
                }
                var html = '';
                for (var i = 0; i < data.data.length; i++) {
                    var status = '未知';
                    //任务状态 1启动 0停止 -1正在等待停止 2正在执行
                    switch (data.data[i].status) {
                        case 1:
                            status = "启动";
                            break;
                        case 0:
                            status = "停止";
                            break;
                        case -1:
                            status = "正在等待停止";
                            break;
                        case 2:
                            status = "正在执行";
                            break;
                    }
                    //?action=start/stop/once&id=xxx
                    var oper = '';
                    if (data.data[i].status == 0) {
                        //停止状态
                        oper += '<a href="#" data-oper="edit" data-name="' + data.data[i].name + '" data-id="' + data.data[i].id + '">修改</a>&nbsp;';
                        oper += '<a href="#" data-oper="del" data-name="' + data.data[i].name + '" data-id="' + data.data[i].id + '">删除</a>&nbsp;';
                        oper += '<a href="#" data-oper="start" data-name="' + data.data[i].name + '" data-id="' + data.data[i].id + '">启动</a>&nbsp;';
                        oper += '<a href="#" data-oper="once" data-name="' + data.data[i].name + '" data-id="' + data.data[i].id + '">运行一次</a>&nbsp;';
                    }
                    if (data.data[i].status != -1 && data.data[i].status != 2) {
                        //启动状态（未在运行）
                    }
                    if (data.data[i].status == 1) {
                        //启动状态（可能在运行也可能不在运行）
                        oper += '<a href="#" data-oper="stop" data-name="' + data.data[i].name + '" data-id="' + data.data[i].id + '">停止</a>&nbsp;';
                    }
                    oper += '<a href="#" data-oper="run-info" data-name="' + data.data[i].name + '" data-id="' + data.data[i].id + '">运行日志</a>';
                    // html += '\
                    //     <div class="mui-row">\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].id + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ status + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].name + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;" title="second,minute,hour,day,month,week">'+ data.data[i].schedule + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].exec_type + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].exec_path + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].exec_file + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].create_time + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].start_time + '</div>\
                    //         <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].stop_time + '</div>\
                    //         <div class="mui-col-xs-2">'+ oper + '</div>\
                    //     </div>\
                    //     <div class="mui-row">\
                    //         <div class="mui-col-xs-12" style="border-top: 1px solid;">&nbsp;</div>\
                    //     </div>\
                    // ';
                    html += '\
                        <div class="mui-row">\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].name + '</div>\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ status + '</div>\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;" title="second,minute,hour,day,month,week">'+ data.data[i].schedule + '</div>\
                            <div class="mui-col-xs-2" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].exec_path + '</div>\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].exec_file + '</div>\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].create_time + '</div>\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].start_time + '</div>\
                            <div class="mui-col-xs-1" style="word-break:break-all;border-right: 1px solid;">'+ data.data[i].stop_time + '</div>\
                            <div class="mui-col-xs-3">'+ oper + '</div>\
                        </div>\
                        <div class="mui-row">\
                            <div class="mui-col-xs-12" style="border-top: 1px solid;">&nbsp;</div>\
                        </div>\
                    ';
                }
                $('.content').html(html);
                $('a').off('click').on('click', function () {
                    // debugger;
                    var oper = $(this).attr('data-oper');
                    var id = $(this).attr('data-id');
                    var name = $(this).attr('data-name');
                    var msg = $(this).html();
                    if (oper == 'once' || oper == 'start' || oper == 'stop' || oper == 'del') {
                        mui.confirm('确认' + msg + '"' + name + '"？"', '警告', ['确认', '取消'], function (event) {
                            if (event.index == 0) {
                                // mui.toast('确认');
                                $ajax({
                                    url: '/api/cron/oper?action=' + oper + '&id=' + id,
                                    success: function (data) {
                                        if (data.error_code == 0) {
                                            mui.alert(msg + '成功', function () {
                                                load();
                                            });
                                        } else {
                                            mui.alert(msg + '失败');
                                        }
                                    }
                                });
                            } else {
                                mui.toast('取消操作');
                            }
                        });
                    } else {
                        if (oper == 'edit') {
                            window.location.href = "edit.html?id=" + id;
                        }
                        if (oper == 'run-info') {
                            window.location.href = "info.html?id=" + id;
                        }
                    }
                });
            }, error: function () {
                mui.hideLoading();
                mui.alert('获取列表异常');
            }
        });
    }

    // function autoref(){
    //     var t = document.getElementById('auto_ref_time').value;
    //     console.log(t);
    // }
</script>

<body>
    <div class="mui-row">
        <button type="button" onclick="javascript:window.location.href='edit.html'">新增</button>
        <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
        <span>每隔</span>
        <select id="auto_ref_time" style="width: 100px;">
            <option value="0">从不</option>
            <option value="1">1秒</option>
            <option value="5">5秒</option>
            <option value="15">15秒</option>
            <option value="30">30秒</option>
            <option value="60">60秒</option>
            <option value="300">5分钟</option>
            <option value="600">10分钟</option>
        </select>
        自动刷新
        <br>
    </div>
    <div class="mui-row">
        <div class="mui-col-xs-12" style="border-top: 1px solid;">&nbsp;</div>
    </div>
    <div class="mui-row">
        <!-- <div class="mui-col-xs-1" style="border-right: 1px solid;">编号</div> -->
        <div class="mui-col-xs-1" style="border-right: 1px solid;">名称</div>
        <div class="mui-col-xs-1" style="border-right: 1px solid;">状态</div>
        <div class="mui-col-xs-1" style="border-right: 1px solid;" title="second,minute,hour,day,month,week">计划</div>
        <!-- <div class="mui-col-xs-1" style="border-right: 1px solid;">类型</div> -->
        <!-- <div class="mui-col-xs-1" style="border-right: 1px solid;">运行目录</div> -->
        <div class="mui-col-xs-2" style="border-right: 1px solid;">运行目录</div>
        <div class="mui-col-xs-1" style="border-right: 1px solid;">启动文件</div>
        <div class="mui-col-xs-1" style="border-right: 1px solid;">创建时间</div>
        <div class="mui-col-xs-1" style="border-right: 1px solid;">启动时间</div>
        <div class="mui-col-xs-1" style="border-right: 1px solid;">停止时间</div>
        <!-- <div class="mui-col-xs-2">操作</div> -->
        <div class="mui-col-xs-3">操作</div>
    </div>
    <div class="mui-row">
        <div class="mui-col-xs-12" style="border-top: 1px solid;">&nbsp;</div>
    </div>
    <div class="content" style="width: 100%;height: 100%;">

    </div>
</body>

</html>